# encoding: utf-8
# copyright: 2020, eNFence GmbH

title 'bind_advisory17'

control 'CVE-2020-8617' do
  impact 0.75
  title 'Vulnerabilities in BIND affect AIX (CVE-2020-8617)'
  desc 'ISC BIND is vulnerable to a denial of service, caused by a
        logic error in code which checks TSIG validity. A remote attacker
        could exploit this vulnerability to trigger an assertion failure in
        tsig.c.
  '

  tag 'aix', 'aix61', 'aix71', 'aix72'
  tag 'vios'
  tag :score, '7.5'
  ref 'http://aix.software.ibm.com/aix/efixes/security/bind_advisory17.asc'

  only_if do
    os.aix?
  end

  # AIX 6.1, 7.1
  describe command('/usr/bin/lslpp -Lqc bos.net.tcp.client') do
    its('stdout') { should_not match(/:6\.1\.[0-8]\./) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[1-3][0-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.40[01]:/) }
    its('stdout') { should_not match(/:7\.1\.[0-4]\./) }
    its('stdout') { should_not match(/:7\.1\.5\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.[12][0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.3[01]:/) }
  end

  # AIX 7.2
  describe command('/usr/bin/lslpp -Lqc bos.net.tcp.bind_utils') do
    its('stdout') { should_not match(/:7\.2\.[01]\./) }
    its('stdout') { should_not match(/:7\.2\.2\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.2\.2\.1[0-7]:/) }
    its('stdout') { should_not match(/:7\.2\.3\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.2\.3\.1[0-5]:/) }
  end

  # AIX 6.1 TL9
  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:6\.1\.9\.40[2-4]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ26021sDa/) }
    end
  end

  # AIX 7.1 TL5
  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:7\.1\.5\.3[2-5]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ25924s6a/) }
    end
  end

  # AIX 7.2 TL2
  if command('/usr/bin/lslpp -Lqc bos.net.tcp.bind_utils').stdout.match(/:7\.2\.2\.18:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ25925s6a/) }
    end
  end

  # AIX 7.2 TL3
  if command('/usr/bin/lslpp -Lqc bos.net.tcp.bind_utils').stdout.match(/:7\.2\.3\.16:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ25926s5a/) }
    end
  end

  # AIX 7.2 TL4
  if command('/usr/bin/lslpp -Lqc bos.net.tcp.bind_utils').stdout.match(/:7\.2\.4\.[01]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ25927s2a/) }
    end
  end
end
