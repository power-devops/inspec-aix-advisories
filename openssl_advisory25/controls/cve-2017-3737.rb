# encoding: utf-8
# copyright: 2017, The Authors

title 'openssl_advisory25'

control 'CVE-2017-373' do
  impact 0.59
  title 'Vulnerability in OpenSSL used by AIX'
  desc 'OpenSSL could allow a remote attacker to bypass security
  restrictions, caused by a flaw in the "error state" mechanism when
  directly calling SSL_read() or SSL_write() for an SSL object after
  receiving a fatal error. An attacker could exploit this vulnerability
  to bypass the decryption or encryption process and perform unauthorized
  actions.
  '

  tag 'openssl'
  tag :score, '5.9'
  ref 'https://aix.software.ibm.com/aix/efixes/security/openssl_advisory25.asc'

  only_if do
    os.aix?
  end

  describe command('/usr/bin/lslpp -Lqc openssl.base') do
    its('stdout') { should_not match(/:0\.[0-9]\./) }
    its('stdout') { should_not match(/:1\.0\.[01]\./) }
    its('stdout') { should_not match(/:1\.0\.2\.0/) }
    its('stdout') { should_not match(/:1\.0\.2\.1[0-2]/) }
  end

  describe command('/usr/bin/lslpp -Lqc openssl.base') do
    its('stdout') { should_not match(/:20\.0\./) }
    its('stdout') { should_not match(/:20\.1[0-2]\./) }
    its('stdout') { should_not match(/:20\.13\.0/) }
    its('stdout') { should_not match(/:20\.13\.10[01]/) }
    its('stdout') { should_not match(/:20\.13\.102\.0/) }
    its('stdout') { should_not match(/:20\.13\.102\.1[0-2]/) }
  end

  if command('/usr/bin/lslpp -Lqc openssl.base').stdout.match(/:1\.0\.2\.1300:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/102m_ifix/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc openssl.base').stdout.match(/:20\.13\.102\.1300:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/fips_102m/) }
    end
  end
end
