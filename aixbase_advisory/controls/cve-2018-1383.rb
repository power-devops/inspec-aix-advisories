# encoding: utf-8
# copyright: 2018, eNFence GmbH

title 'aixbase_advisory'

control 'CVE-2018-1383' do
  impact 0.91
  title 'Vulnerability impacts AIX and VIOS (CVE-2018-1383)'
  desc 'A software logic bug creates a vulnerability in an AIX 6.1, 
        7.1, and 7.2 daemon which could allow a user with root privileges on 
        one system, to obtain root access on another machine.
  '

  tag 'aix', 'aix61', 'aix71', 'aix72'
  tag 'vios'
  tag :score, '9.1'
  ref 'http://aix.software.ibm.com/aix/efixes/security/aixbase_advisory.asc'

  only_if do
    os.aix?
  end

  only_if do
    command('/usr/bin/lslpp -Lqc bos.cluster.rte').exit_status == 0
  end

  describe command('/usr/bin/lslpp -Lqc bos.cluster.rte') do
    its('stdout') { should_not match(/:6\.1\.[0-8]\./) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-1]/) }
    its('stdout') { should_not match(/:7\.1\.[0-3]\./) }
    its('stdout') { should_not match(/:7\.1\.4\.[0-2]/) }
    its('stdout') { should_not match(/:7\.2\.0\.[0-2]:/) }
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:6\.1\.9\.200:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02726s8a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:6\.1\.9\.201:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02726s9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:6\.1\.9\.202:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02726s9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:6\.1\.9\.300:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02726sAa/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:7\.1\.4\.30:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02825s3a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:7\.1\.4\.31:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02825s4a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:7\.1\.4\.32:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02825s5a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:7\.1\.5\.0:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02727s1a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:7\.2\.0\.3:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02827s3a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:7\.2\.0\.4:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02827s4a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:7\.2\.0\.5:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02827s5a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:7\.2\.1\.0:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02828s1a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:7\.2\.1\.1:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02828s2a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:7\.2\.1\.2:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02828s3a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.cluster.rte').stdout.match(/:7\.2\.2\.0:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ02729s1a/) }
    end
  end
end
