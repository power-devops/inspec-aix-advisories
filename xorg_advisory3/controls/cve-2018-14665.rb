# encoding: utf-8
# copyright: 2018, eNFence GmbH

title 'xorg_advisory3'

control 'CVE-2018-14665' do
  impact 0.88
  title 'Vulnerability in Xorg affects AIX (CVE-2018-14665)'
  desc 'X.Org X server could allow a remote authenticated attacker 
        to gain elevated privileges on the system, caused by improper 
        validation of command line parameters. An attacker could exploit this 
        vulnerability using the -modulepath argument or the -logfile argument 
        to overwrite arbitrary files and execute unprivileged code on the 
        system.
  '

  tag 'aix', 'aix53', 'aix61', 'aix71', 'aix72'
  tag 'vios', 'vios2', 'vios3'
  tag :score, '8.8'
  ref 'ftp://aix.software.ibm.com/aix/efixes/security/xorg_advisory3.asc'

  only_if do
    os.aix?
  end

  describe command('/usr/bin/lslpp -Lqc X11.base.rte') do
    its('stdout') { should_not match(/:5\.3\.[0-9]\./) }
    its('stdout') { should_not match(/:5\.3\.1[01]\./) }
    its('stdout') { should_not match(/:6\.1\.[0-8]\./) }
    its('stdout') { should_not match(/:7\.1\.[0-3]\./) }
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:5\.3\.12\.[0-2]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11551s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:6\.1\.9\.[0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11000s0b/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:6\.1\.9\.[0-9][0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11000s0b/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:6\.1\.9\.100:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11000s0b/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.1\.4\.[0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11544s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.1\.4\.[1-2][0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11544s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.1\.4\.3[01]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11544s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.1\.5\.[0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11545s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.1\.5\.[12][0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11545s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.1\.5\.3[01]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11545s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.2\.0\.[01]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11546s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.2\.1\.0:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11547s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.2\.2\.[0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11549s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.2\.2\.1[0-6]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11549s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.2\.3\.[0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11550s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc X11.base.rte').stdout.match(/:7\.2\.3\.1[0-5]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ11550s0a/) }
    end
  end
end
