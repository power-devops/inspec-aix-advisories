# encoding: utf-8
# copyright: 2015, The Authors

title 'rmsock_advisory2'

control 'CVE-2018-1655' do
  impact 0.4
  title 'Vulnerability in rmsock affects AIX (CVE-2018-1655)'
  desc 'There is a vulnerability in the rmsock command that affects AIX.
  '
  tag 'aix', 'vios', 'aix71', 'aix72', 'aix61', 'aix53'
  tag :score, '4.0'
  ref 'http://aix.software.ibm.com/aix/efixes/security/rmsock_advisory2.asc'

  only_if do
    os.aix?
  end

  describe command('/usr/bin/lslpp -Lqc bos.net.tcp.client') do
    its('stdout') { should_not match(/:5\.3\.12\.[0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-1]/) }
    its('stdout') { should_not match(/:6\.1\.9\.200:/) }
    its('stdout') { should_not match(/:6\.1\.9\.30[0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.31[0-5]:/) }
    its('stdout') { should_not match(/:7\.1\.4\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.4\.[12][0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.4\.30:/) }
  end

  describe command('/usr/bin/lslpp -Lqc bos.net.tcp.client_core') do
    its('stdout') { should_not match(/:7\.2\.0\.[0-2]:/) }
    its('stdout') { should_not match(/:7\.2\.1\.0:/) }
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:5\.3\.12\.10:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06935s1a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:6\.1\.9\.20[1-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06905s9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:6\.1\.9\.2[1-9][0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06905s9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:6\.1\.9\.30[0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06905s9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:6\.1\.9\.31[0-5]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06905s9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:7\.1\.4\.3[1-3]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06906s4a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:7\.1\.5\.[0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06904s5a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:7\.1\.5\.1[0-5]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06904s5a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client_core').stdout.match(/:7\.2\.0\.[3-5]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06934s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client_core').stdout.match(/:7\.2\.1\.[1-3]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06907s1a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client_core').stdout.match(/:7\.2\.2\.[0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06908s2a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client_core').stdout.match(/:7\.2\.2\.1[0-6]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06908s2a/) }
    end
  end
end
