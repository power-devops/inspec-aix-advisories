# encoding: utf-8
# copyright: 2018, eNFence GmbH

title 'tcpdump_advisory4'

control 'CVE-2018-19519' do
  impact 0.73
  title 'There is a vulnerability in tcpdump that affects AIX'
  desc 'Tcpdump is vulnerable to a stack-based buffer overflow, 
        caused by improper bounds checking by the print_prefix function of 
        print-hncp.c. By using a specially-crafted packet data, a remote 
        attacker could overflow a buffer and execute arbitrary code on the 
        system or cause the application to crash.
  '

  tag 'tcpdump'
  tag 'aix', 'aix61', 'aix71', 'aix72'
  tag 'vios', 'vios2', 'vios3'
  tag :score, '7.3'
  ref 'https://aix.software.ibm.com/aix/efixes/security/tcpdump_advisory4.asc'

  only_if do
    os.aix?
  end

  cmd71 = command('/usr/bin/lslpp -Lqc bos.net.tcp.server')
  cmd72 = command('/usr/bin/lslpp -Lqc bos.net.tcp.tcpdump')
  emgr = command('/usr/sbin/emgr -l')

  # AIX 6.1

  # AIX 7.1
  describe cmd71 do
    its('stdout') { should_not match(/:7\.1\.5\.[1-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.1[0-47-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.2[0-9]:/) }
  end

  # AIX 7.2
  describe cmd72 do
    its('stdout') { should_not match(/:7\.2\.3\.0:/) }
  end

  # Fix for AIX 6.1 bos.net.tcp.server 6.1.9.100-6.1.9.315
  if cmd71.stdout.match(/:6\.1\.9\.[12][0-9][0-9]:/)
    describe emgr do
      its('stdout') { should match(/IJ12978s9a/) }
    end
  end
  if cmd71.stdout.match(/:6\.1\.9\.30[0-9]:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ12978s9a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ12978sBa/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ12978sCa/) }
      end
    end
  end
  if cmd71.stdout.match(/:6\.1\.9\.31[0-5]:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ12978s9a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ12978sBa/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ12978sCa/) }
      end
    end
  end

  # Fix for AIX 6.1 bos.net.tcp.server 6.1.9.316-6.1.9.400
  if cmd71.stdout.match(/:6\.1\.9\.31[6-9]:/)
    describe emgr do
      its('stdout') { should match(/IJ12978sCa/) }
    end
  end
  if cmd71.stdout.match(/:6\.1\.9\.3[2-9][0-9]:/)
    describe emgr do
      its('stdout') { should match(/IJ12978sCa/) }
    end
  end
  if cmd71.stdout.match(/:6\.1\.9\.400:/)
    describe emgr do
      its('stdout') { should match(/IJ12978sCa/) }
    end
  end

  # Fix for AIX 7.1 bos.net.tcp.server 7.1.4.32
  if cmd71.stdout.match(/:7\.1\.4\.32:/)
    describe emgr do
      its('stdout') { should match(/IJ12979m5a/) }
    end
  end

  # Fix for AIX 7.1 bos.net.tcp.server 7.1.4.33
  if cmd71.stdout.match(/:7\.1\.4\.33:/)
    describe emgr do
      its('stdout') { should match(/IJ12979m6a/) }
    end
  end

  # Fix for AIX 7.1 bos.net.tcp.server 7.1.4.34
  if cmd71.stdout.match(/:7\.1\.4\.34:/)
    describe emgr do
      its('stdout') { should match(/IJ2979m7a/) }
    end
  end

  # Fix for AIX 7.1 bos.net.tcp.server 7.1.5.0
  if cmd71.stdout.match(/:7\.1\.5\.0/)
    describe emgr do
      its('stdout') { should match(/IJ12980m1a/) }
    end
  end

  # Fix for AIX 7.1 bos.net.tcp.server 7.1.5.15/16
  if cmd71.stdout.match(/:7\.1\.5\.1[56]/)
    describe emgr do
      its('stdout') { should match(/IJ12980m2a/) }
    end
  end

  # Fix for AIX 7.1 bos.net.tcp.server 7.1.5.30/31
  if cmd71.stdout.match(/:7\.1\.5\.3[01]/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ12980m3a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ20783s5a/) }
      end
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.1.1
  if cmd72.stdout.match(/:7\.2\.1\.1:/)
    describe emgr do
      its('stdout') { should match(/IJ12981m3a/) }
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.1.2
  if cmd72.stdout.match(/:7\.2\.1\.2:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ12981m3a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ12981m4a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ12981m5a/) }
      end
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.1.3
  if cmd72.stdout.match(/:7\.2\.1\.3:/)
    describe emgr do
      its('stdout') { should match(/IJ12981m5a/) }
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.2.0-7.2.2.1
  if cmd72.stdout.match(/:7\.2\.2\.[01]:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ12982m1a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ12982m2a/) }
      end
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.2.2-7.2.2.9
  if cmd72.stdout.match(/:7\.2\.2\.[2-9]:/)
    describe emgr do
      its('stdout') { should match(/IJ12982m2a/) }
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.2.10-7.2.2.14
  if cmd72.stdout.match(/:7\.2\.2\.1[0-4]:/)
    describe emgr do
      its('stdout') { should match(/IJ12982m2a/) }
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.2.15
  if cmd72.stdout.match(/:7\.2\.2\.15:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ12982m2a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ12982m3a/) }
      end
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.2.16
  if cmd72.stdout.match(/:7\.2\.2\.16:/)
    describe emgr do
      its('stdout') { should match(/IJ12982m3a/) }
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.3.0
  if cmd72.stdout.match(/:7\.2\.3\.0:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ12983m0a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ12983m1a/) }
      end
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.3.1
  if cmd72.stdout.match(/:7\.2\.3\.1:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ12983m1a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ12983m2a/) }
      end
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.3.2-7.2.3.15
  if cmd72.stdout.match(/:7\.2\.3\.[2-9]:/)
    describe emgr do
      its('stdout') { should match(/IJ12983m2a/) }
    end
  end
  if cmd72.stdout.match(/:7\.2\.3\.1[0-5]:/)
    describe emgr do
      its('stdout') { should match(/IJ12983m2a/) }
    end
  end
end

