# encoding: utf-8
# copyright: 2017, The Authors

title 'ntp_advisory12'

control 'CVE-2019-8936' do
  impact 0.53
  title 'CVE-2019-8936'
  desc 'NTP is vulnerable to a denial of service, caused by a NULL 
        pointer dereference in ntp_control.c. By sending specially crafted 
        mode 6 packets, a remote authenticated attacker could exploit this 
        vulnerability to cause the ntpd daemon to SIGSEGV.
  '

  tag 'ntp', 'aix', 'aix61', 'aix71', 'aix72', 'vio', 'vio22', 'vio3'
  tag :score, '5.3'
  ref 'http://aix.software.ibm.com/aix/efixes/security/ntp_advisory12.asc'

  only_if do
    os.aix?
  end

  tcpcl_cmd = command('/usr/bin/lslpp -Lqc bos.net.tcp.client')
  ntp_cmd = command('/usr/bin/lslpp -Lqc bos.net.tcp.ntp')
  ntpd_cmd = command('/usr/bin/lslpp -Lqc bos.net.tcp.ntpd')

  describe tcpcl_cmd do
    its('stdout') { should_not match(/:6\.1\.9\.[0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-2][0-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.30[0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.31[0-4]:/) }
  end

  if tcpcl_cmd.stdout.match(/:6\.1\.9\.31[5-9]:/) ||
     tcpcl_cmd.stdout.match(/:6\.1\.9\.3[2-9][0-9]:/) ||
     tcpcl_cmd.stdout.match(/:6\.1\.9\.40[0-4]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ17059m9b/) }
    end
  end

  describe tcpcl_cmd do
    its('stdout') { should_not match(/:7\.1\.4\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.4\.[0-2][0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.4\.3[0-5]:/) }
  end

  if tcpcl_cmd.stdout.match(/:7\.1\.4\.3[3-5]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ17061m8a/) }
    end
  end

  describe tcpcl_cmd do
    its('stdout') { should_not match(/:7\.1\.5\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.0[0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.1[0-5]:/) }
  end

  if tcpcl_cmd.stdout.match(/:7\.1\.5\.1[5-9]:/) ||
     tcpcl_cmd.stdout.match(/:7\.1\.5\.2[0-9]:/) ||
     tcpcl_cmd.stdout.match(/:7\.1\.5\.3[0-3]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ17062m4a/) }
    end
  end

  describe ntp_cmd do
    its('stdout') { should_not match(/:7\.2\.1\.[0-1]:/) }
  end

  describe ntpd_cmd do
    its('stdout') { should_not match(/:7\.2\.1\.0:/) }
  end

  if ntp_cmd.stdout.match(/:7\.2\.1\.[23]:/) &&
     ntpd_cmd.stdout.match(/:7\.2\.1\.[12]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ17063m6a/) }
    end
  end

  describe ntp_cmd do
    its('stdout') { should_not match(/:7\.2\.2\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.2\.2\.1[0-4]:/) }
  end

  describe ntpd_cmd do
    its('stdout') { should_not match(/:7\.2\.2\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.2\.2\.1[0-4]:/) }
  end

  if ntp_cmd.stdout.match(/:7\.2\.2\.1[5-7]:/) &&
     ntpd_cmd.stdout.match(/:7\.2\.2\.1[5-7]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ17064m4a/) }
    end
  end

  if ( ntp_cmd.stdout.match(/:7\.2\.3\.[0-9]:/) &&
     ntpd_cmd.stdout.match(/:7\.2\.3\.[0-9]:/) ) || 
     ( ntp_cmd.stdout.match(/:7\.2\.3\.1[0-5]:/) &&
     ntpd_cmd.stdout.match(/:7\.2\.3\.1[0-5]:/) )
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ17065m3a/) }
    end
  end

  describe command('/usr/bin/lslpp -Lqc ntp.rte') do
    its('stdout') { should_not match(/:7\.4\.2\.81[0-1][0-9]:/) }
    its('stdout') { should_not match(/:7\.4\.2\.812[01]:/) }
  end

  if command('/usr/bin/lslpp -Lqc ntp.rte').stdout.match(/:7\.4\.2\.811[0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ17059m9b/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc ntp.rte').stdout.match(/:7\.4\.2\.812[0-1]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ17059m9b/) }
    end
  end
end
