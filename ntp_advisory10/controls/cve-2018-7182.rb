# encoding: utf-8
# copyright: 2017, The Authors

title 'ntp_advisory10'

control 'CVE-2018-7182' do
  impact 0.53
  title 'CVE-2018-7182'
  desc 'NTP could allow a remote attacker to obtain sensitive 
        information, caused by a leak in the ctl_getitem() function. By 
        sending a specially crafted mode 6 packet, an attacker could exploit 
        this vulnerability to read past the end of its buffer.
  '

  tag 'ntp', 'aix', 'aix53', 'aix61', 'aix71', 'aix72'
  tag :score, '5.3'
  ref 'http://aix.software.ibm.com/aix/efixes/security/ntp_advisory10.asc'

  only_if do
    os.aix?
  end

  describe command('/usr/bin/lslpp -Lqc bos.net.tcp.client') do
    its('stdout') { should_not match(/:5\.3\.12\.[0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.1[0-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.200:/) }
    its('stdout') { should_not match(/:7\.1\.4\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.4\.[12][0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.4\.30:/) }
  end

  describe command('/usr/bin/lslpp -Lqc bos.net.tcp.ntpd') do
    its('stdout') { should_not match(/:7\.2\.0\.[0-2]:/) }
    its('stdout') { should_not match(/:7\.2\.1\.0:/) }
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:5\.3\.12\.10:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06657m9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:6\.1\.9\.20[1-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06651m9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:6\.1\.9\.2[1-9][0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06651m9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:6\.1\.9\.30[0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06651m9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:6\.1\.9\.31[0-5]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06651m9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:7\.1\.4\.3[1-3]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06652m4a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:7\.1\.5\.[0-9]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06653m0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout.match(/:7\.1\.5\.1[0-5]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06653m0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.ntpd').stdout.match(/:7\.2\.0\.[34]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06654m4a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.ntpd').stdout.match(/:7\.2\.1\.[12]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06655m2a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.ntpd').stdout.match(/:7\.2\.1\.[12]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06655m2a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.ntpd').stdout.match(/:7\.2\.2\.[0-9]:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ06656m0a/) }
      end
      describe command('/usr/sbin/instfix -ik IJ06656') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.net.tcp.ntpd').stdout.match(/:7\.2\.2\.1[0-5]:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ06656m0a/) }
      end
      describe command('/usr/sbin/instfix -ik IJ06656') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc ntp.rte').stdout.match(/:7\.4\.2\.8100:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ06400s9a/) }
    end
  end
end
