# encoding: utf-8
# copyright: 2018, eNFence GmbH

title 'variant4_advisory'

control 'CVE-2018-3639' do
  impact 1.0
  title 'IBM has released AIX and VIOS iFixes in response to Speculative Store Bypass (SSB), also known as Variant 4.'
  desc 'IBM has released the following fixes for AIX and VIOS in response to 
     CVE-2018-3639.
  '

  tag 'aix', 'aix53', 'aix61', 'aix71', 'aix72'
  tag 'vios'
  tag :score, '10.0'
  ref 'http://aix.software.ibm.com/aix/efixes/security/variant4_advisory.asc'

  describe command('/usr/bin/lslpp -Lqc bos.mp64') do
    its('stdout') { should_not match(/:5\.3\.12\.[0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.[0-8]\./) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.1[0-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.20[02-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.2[1-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.30[1-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.31[0-4]:/) }
    its('stdout') { should_not match(/:7\.1\.[0-3]\./) }
    its('stdout') { should_not match(/:7\.1\.4\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.4\.[0-2][0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.4\.3[0-1]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.[1-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.1[0-4]:/) }
    its('stdout') { should_not match(/:7\.2\.0\.[0-3]:/) }
    its('stdout') { should_not match(/:7\.2\.1\.[0-2]:/) }
    its('stdout') { should_not match(/:7\.2\.2\.[1-9]:/) }
    its('stdout') { should_not match(/:7\.2\.2\.1[0-4]:/) }
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:5\.3\.12\.10:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05826m9b/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05826') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:6\.1\.9\.201:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05824m9a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05824') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:6\.1\.9\.300:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05824mAa/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05824') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:6\.1\.9\.31[56]:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05824sBa/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05824') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.1\.4\.32:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05823m4a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05823') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.1\.4\.33:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05823m5a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05823') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.1\.4\.34:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05823m6a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05823') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.1\.5\.0:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05822m1a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05822') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.1\.5\.1[56]:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05822s2a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05822') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.2\.0\.4:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05821m4a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05821') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.2\.0\.5:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05821m5a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05821') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.2\.0\.6:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05821m6a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05821') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.2\.1\.3:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05820m2a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05820') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.2\.1\.4:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05820m3a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05820') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.2\.1\.5:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05820m4a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05820') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.2\.2\.0:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05818m1a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05818') do
        its('exit_status') { should eq 0 }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.mp64').stdout.match(/:7\.2\.2\.1[56]:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ05818s2a/) }
      end

      describe command('/usr/sbin/instfix -ik IJ05818') do
        its('exit_status') { should eq 0 }
      end
    end
  end
end
