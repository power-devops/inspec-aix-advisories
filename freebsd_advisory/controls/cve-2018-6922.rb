# encoding: utf-8
# copyright: 2017, The Authors

title 'freebsd_advisory'

control 'CVE-2018-6922' do
  impact 0.75
  title 'CVE-2018-6922'
  desc 'FreeBSD is vulnerable to a denial of service, caused by the 
        use of an inefficient TCP reassembly algorithm. By sending 
        specially-crafted TCP traffic, a remote attacker could exploit this 
        vulnerability to consume all available CPU resources.
  '

  tag 'ntp', 'aix', 'aix53', 'aix61', 'aix71', 'aix72'
  tag :score, '7.5'
  ref 'http://aix.software.ibm.com/aix/efixes/security/freebsd_advisory.asc'

  only_if do
    os.aix?
  end

  describe command('/usr/bin/lslpp -Lqc bos.rte') do
    its('stdout') { should_not match(/:5\.3\.12\.0:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[12][0-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.30[1-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.31[012346789]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.3[2-9][0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.4\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.4\.[12][0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.[1-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.1[0-46-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.2[0-9]:/) }
    its('stdout') { should_not match(/:7\.2\.0\.0:/) }
    its('stdout') { should_not match(/:7\.2\.2\.[1-9]:/) }
    its('stdout') { should_not match(/:7\.2\.2\.1[0-4]:/) }
    its('stdout') { should_not match(/:7\.2\.3\.[1-9]:/) }
    its('stdout') { should_not match(/:7\.2\.3\.1[0-4]:/) }
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:5\.3\.12\.1:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09618s9a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:6\.1\.9\.300:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09619sAa/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:6\.1\.9\.315:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09619sBa/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:6\.1\.9\.400:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09619sCa/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.1\.4\.30:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09620s4a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.1\.4\.31:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09620s5a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.1\.4\.32:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09620s6a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.1\.5\.0:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09621s1a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.1\.5\.15:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09621s2a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.1\.5\.30:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09621s3a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.2\.0\.1:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09622s4a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.2\.0\.2:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09622s5a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.2\.0\.3:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09622s6a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.2\.1\.0:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09623s2a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.2\.1\.1:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09623s3a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.2\.1\.2:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09623s4a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.2\.2\.0:/)
    describe.one do
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ09624s0a/) }
      end
      describe command('/usr/sbin/emgr -l') do
        its('stdout') { should match(/IJ09624s1a/) }
      end
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.2\.2\.15:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09624s2a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.2\.3\.0:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09625s0a/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc bos.rte').stdout.match(/:7\.2\.3\.15:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ09625s2a/) }
    end
  end
end
