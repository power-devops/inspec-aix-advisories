# encoding: utf-8
# copyright: 2015, The Authors

title 'nas_advisory3'

# you add controls here
control 'CVE-2014-5355' do                        # A unique ID for this control
  impact 0.5                                # The criticality, if this control fails.
  title 'AIX NAS Denial of Service via a zero-byte version string or by omitting the \0 character'
  desc 'A remote attackers can cause a denial of service (NULL pointer dereference) 
	via a zero-byte version string or  cause a denial of service(out-of-bounds 
	read) by omitting the \0 character. 
  '
  tag 'kerberos', 'nas'
  tag :score, '5.0'
  ref 'https://aix.software.ibm.com/aix/efixes/security/nas_advisory3.asc'

  only_if do
    os.aix?
  end

  describe command('lslpp -Lqc krb5.client.rte') do
    its('stdout') { should_not match(/:1\.[0-4]\./) }
    its('stdout') { should_not match(/:1\.5\.0\.[0-6]:/) } 
    its('stdout') { should_not match(/:1\.6\.0\.[0-1]:/) } 
  end

  describe command('lslpp -Lqc krb5.server.rte') do
    its('stdout') { should_not match(/:1\.[0-4]\./) }
    its('stdout') { should_not match(/:1\.5\.0\.[0-6]:/) } 
    its('stdout') { should_not match(/:1\.6\.0\.[0-1]:/) } 
  end

  if command('lslpp -Lqc krb5.client.rte').stdout.match(/:1\.5\.0\.7:/)
    describe command('emgr -l') do                  # The actual test
      its('stdout') { should match(/1507c_fix/) }
    end
  end

  if command('lslpp -Lqc krb5.client.rte').stdout.match(/:1\.6\.0\.2:/)
    describe command('emgr -l') do
      its('stdout') { should match(/1602c_fix/) }
    end
  end

  if command('lslpp -Lqc krb5.server.rte').stdout.match(/:1\.5\.0\.7:/)
    describe command('emgr -l') do                  # The actual test
      its('stdout') { should match(/1507s_fix/) }
    end
  end

  if command('lslpp -Lqc krb5.server.rte').stdout.match(/:1\.6\.0\.2:/)
    describe command('emgr -l') do                  # The actual test
      its('stdout') { should match(/1602s_fix/) }
    end
  end
end
