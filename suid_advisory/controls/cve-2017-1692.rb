# encoding: utf-8
# copyright: 2018, eNFence GmbH

title 'suid_advisory'

control 'CVE-2017-1692' do
  impact 0.84
  title 'Vulnerabilities in bellmail, caccelstat, iostat, lquerypv, restbyinode, and vmstat affect AIX'
  desc 'IBM AIX contains an unspecified vulnerability that would
        allow a locally authenticated user to obtain root level privileges.'

  tag 'aix', 'aix61', 'aix71', 'aix72'
  tag 'vios'
  tag :score, '8.4'
  ref 'http://aix.software.ibm.com/aix/efixes/security/suid_advisory.asc'

  only_if do
    os.aix?
  end

  describe command('/usr/bin/lslpp -Lqc bos.net.tcp.client') do
    its('stdout') { should_not match(/:6\.1\.[0-8]\./) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9].:/) }
    its('stdout') { should_not match(/:6\.1\.9\.100:/) }
    its('stdout') { should_not match(/:7\.1\.[0-3]/) }
    its('stdout') { should_not match(/:7\.1\.4\.0:/) }
  end

  describe command('/usr/bin/lslpp -Lqc bos.net.tcp.client_core') do
    its('stdout') { should_not match(/:7\.2\.0\.0:/) }
  end

  describe command('/usr/bin/lslpp -Lqc bos.acct') do
    its('stdout') { should_not match(/:7\.1\.[0-2]\./) }
    its('stdout') { should_not match(/:7\.1\.3\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.3\.[0-2][0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.3\.3[0-7]:/) }
    its('stdout') { should_not match(/:7\.2\.0\.[01]:/) }
  end

  describe command('/usr/bin/lslpp -Lqc bos.rte.lvm') do
    its('stdout') { should_not match(/:5\.3\.[0-9]\./) }
    its('stdout') { should_not match(/:5\.3\.1[01]\./) }
    its('stdout') { should_not match(/:5\.3\.12\.[0-7]:/) }
    its('stdout') { should_not match(/:6\.1\.[0-8]\./) }
    its('stdout') { should_not match(/:7\.1\.[0-3]\./) }
    its('stdout') { should_not match(/:7\.2\.0\.0:/) }
  end

  describe command('/usr/bin/lslpp -Lqc bos.rte.archive') do
    its('stdout') { should_not match(/:5\.3\.[0-9]\./) }
    its('stdout') { should_not match(/:5\.3\.1[01]\./) }
    its('stdout') { should_not match(/:5\.3\.12\.[0-6]:/) }
    its('stdout') { should_not match(/:6\.1\.[0-8]\./) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9].:/) }
    its('stdout') { should_not match(/:6\.1\.9\.100:/) }
    its('stdout') { should_not match(/:7\.1\.[0-3]\./) }
    its('stdout') { should_not match(/:7\.1\.4\.0:/) }
    its('stdout') { should_not match(/:7\.2\.0\.0:/) }
  end
  
  acct_stdout = command('/usr/bin/lslpp -Lqc bos.acct').stdout

  if acct_stdout.match(/:7\.1\.3\.38:/) || acct_stdout.match(/:7\.1\.4\.[0-9]:/) || 
     acct_stdout.match(/:7\.1\.4\.[0-2][0-9]:/) || acct_stdout.match(/:7\.1\.4\.30:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV97896s4a/) }
    end

    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV97899s4a/) }
    end
  end

  if acct_stdout.match(/:7\.2\.0\.[23]:/) || acct_stdout.match(/:7\.2\.1\.[01]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV97898s2a/) }
    end

    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV97901s2a/) }
    end

    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV97811s2a/) }
    end
  end

  tcpcl_stdout = command('/usr/bin/lslpp -Lqc bos.net.tcp.client').stdout

  if tcpcl_stdout.match(/:6\.1\.9\.101:/) || tcpcl_stdout.match(/:6\.1\.9\.20[01]/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV97356m9a/) }
    end
  end

  if tcpcl_stdout.match(/:7\.1\.4\.[1-9]:/) || tcpcl_stdout.match(/:7\.1\.4\.[12].:/) || tcpcl_stdout.match(/:7\.1\.4\.3[0-2]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV99497m5a/) }
    end
  end

  tcpcl_stdout = command('/usr/bin/lslpp -Lqc bos.net.tcp.client_core').stdout

  if tcpcl_stdout.match(/:7\.2\.0\.[1-4]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV99498m5a/) }
    end
  end

  if tcpcl_stdout.match(/:7\.2\.1\.[0-2]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV99499m3a/) }
    end
  end

  arc_stdout = command('/usr/bin/lslpp -Lqc bos.rte.archive').stdout

  if arc_stdout.match(/:5\.3\.12\.7:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV98013s9a/) }
    end
  end

  if arc_stdout.match(/:6\.1\.9\.101:/) || tcpcl_stdout.match(/:6\.1\.9\.20[01]/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV97852s7a/) }
    end
  end

  if arc_stdout.match(/:7\.1\.4\.[1-9]:/) || arc_stdout.match(/:7\.1\.4\.[12].:/) || arc_stdout.match(/:7\.1\.4\.3[01]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV97957s2b/) }
    end
  end

  if arc_stdout.match(/:7\.2\.0\.[1-4]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV97959s2b/) }
    end
  end

  if arc_stdout.match(/:7\.2\.1\.[0-1]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV97958s0b/) }
    end
  end

  lvm_stdout = command('/usr/bin/lslpp -Lqc bos.rte.lvm').stdout

  if lvm_stdout.match(/:5\.3\.12\.8:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IJ00951s9a/) }
    end
  end

  if lvm_stdout.match(/:6\.1\.9\.[0-9]:/) || lvm_stdout.match(/:6\.1\.9\.[0-9][0-9]:/) || 
     lvm_stdout.match(/:6\.1\.9\.1[0-9][0-9]:/) || lvm_stdout.match(/:6\.1\.9\.20[01]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV99548m9a/) }
    end
  end

  if lvm_stdout.match(/:7\.1\.4\.[0-9]:/) || lvm_stdout.match(/:7\.1\.4\.[12].:/) || lvm_stdout.match(/:7\.1\.4\.3[0-2]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV99550m5a/) }
    end
  end

  if lvm_stdout.match(/:7\.2\.0\.[1-4]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV97959s2b/) }
    end
  end

  if lvm_stdout.match(/:7\.2\.1\.[0-2]:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/IV99552m3a/) }
    end
  end
end
