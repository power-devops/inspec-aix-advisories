# encoding: utf-8
# copyright: 2018, eNFence GmbH

title 'tcpdump_advisory5'

control 'CVE-2018-14879' do
  impact 0.61
  title 'Vulnerabilities in tcpdump affect AIX'
  desc 'The command-line argument parser in tcpdump before 4.9.3 has 
        a buffer overflow in tcpdump.c:get_next_file().
  '

  tag 'tcpdump'
  tag 'aix', 'aix61', 'aix71', 'aix72'
  tag 'vios', 'vios2', 'vios3'
  tag :score, '6.1'
  ref 'https://aix.software.ibm.com/aix/efixes/security/tcpdump_advisory5.asc'

  only_if do
    os.aix?
  end

  cmd71 = command('/usr/bin/lslpp -Lqc bos.net.tcp.server')
  cmd72 = command('/usr/bin/lslpp -Lqc bos.net.tcp.tcpdump')
  emgr = command('/usr/sbin/emgr -l')

  # AIX 6.1
  describe cmd71 do
    its('stdout') { should_not match(/:6\.1\.9\.[0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[0-9][0-9]:/) }
    its('stdout') { should_not match(/:6\.1\.9\.[1-3][0-9][0-9]:/) }
  end

  # AIX 7.1
  describe cmd71 do
    its('stdout') { should_not match(/:7\.1\.5\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.1[0-9]:/) }
    its('stdout') { should_not match(/:7\.1\.5\.2[0-9]:/) }
  end

  # AIX 7.2
  describe cmd72 do
    its('stdout') { should_not match(/:7\.2\.2\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.2\.2\.1[0-4]:/) }
    its('stdout') { should_not match(/:7\.2\.3\.[1-9]:/) }
    its('stdout') { should_not match(/:7\.2\.3\.1[0-4]:/) }
  end

  # Fix for AIX 6.1 bos.net.tcp.server 6.1.9.400
  if cmd71.stdout.match(/:6\.1\.9\.400:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ20781sCc/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ20781sCd/) }
      end
    end
  end

  # Fix for AIX 6.1 bos.net.tcp.server 6.1.9.401
  if cmd71.stdout.match(/:6\.1\.9\.401:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ20781sDa/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ20781sDb/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ20781sEa/) }
      end
    end
  end

  # Fix for AIX 7.1 bos.net.tcp.server 7.1.5.30-1
  if cmd71.stdout.match(/:7\.1\.5\.3[01]:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ20783s3a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ20783s5a/) }
      end
    end
  end

  # Fix for AIX 7.1 bos.net.tcp.server 7.1.5.32
  if cmd71.stdout.match(/:7\.1\.5\.32:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ20783s4a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ20783s5a/) }
      end
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.2.15
  if cmd72.stdout.match(/:7\.2\.2\.15:/)
    describe emgr do
      its('stdout') { should match(/IJ20784s2a/) }
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.2.16
  if cmd72.stdout.match(/:7\.2\.2\.16:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ20784s3a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ20784s4a/) }
      end
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.2.17
  if cmd72.stdout.match(/:7\.2\.2\.17:/)
    describe emgr do
      its('stdout') { should match(/IJ20784s4a/) }
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.3.0
  if cmd72.stdout.match(/:7\.2\.3\.0:/)
    describe emgr do
      its('stdout') { should match(/IJ20785s1a/) }
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.3.15
  if cmd72.stdout.match(/:7\.2\.3\.15:/)
    describe.one do
      describe emgr do
        its('stdout') { should match(/IJ20785s2a/) }
      end
      describe emgr do
        its('stdout') { should match(/IJ20785s3a/) }
      end
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.3.16
  if cmd72.stdout.match(/:7\.2\.3\.16:/)
    describe emgr do
      its('stdout') { should match(/IJ20785s3a/) }
    end
  end

  # Fix for AIX 7.2 bos.net.tcp.tcpdump 7.2.4.0
  if cmd72.stdout.match(/:7\.2\.4\.0:/)
    describe emgr do
      its('stdout') { should match(/IJ20786s1a/) }
    end
  end
end
