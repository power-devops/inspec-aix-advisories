# encoding: utf-8
# copyright: 2018, eNFence GmbH

title 'java_advisory_20180919'

control 'CVE-2018-12539' do
  impact 0.59
  title 'CVE-2018-12539'
  desc 'Eclipse OpenJ9 could allow a local attacker to gain elevated
        privileges on the system, caused by the failure to restrict the use
        of Java Attach API to connect to an Eclipse OpenJ9 or IBM JVM on the
        same machine and use Attach API operations to only the process owner.
        An attacker could exploit this vulnerability to execute untrusted
        native code and gain elevated privileges on the system.
  '
  tag 'java', 'jre', 'java8', 'java7', 'java71'
  tag :score, '8.4'
  ref 'https://aix.software.ibm.com/aix/efixes/security/java_july2018_advisory.asc'

  only_if do
    os.aix?
  end

  describe command('/usr/bin/lslpp -Lqc Java7_64.jre') do
    its('stdout') { should_not match(/:7\.0\.0\.[0-5]/) }
    its('stdout') { should_not match(/:7\.0\.0\.6[0-2]/) }
  end

  describe command('/usr/bin/lslpp -Lqc Java7_64.sdk') do
    its('stdout') { should_not match(/:7\.1\.0\.[0-5]/) }
    its('stdout') { should_not match(/:7\.1\.0\.6[0-2]/) }
  end

  describe command('/usr/bin/lslpp -Lqc Java7.jre') do
    its('stdout') { should_not match(/:7\.0\.0\.[0-5]/) }
    its('stdout') { should_not match(/:7\.0\.0\.6[0-2]/) }
  end

  describe command('/usr/bin/lslpp -Lqc Java7.sdk') do
    its('stdout') { should_not match(/:7\.0\.0\.[0-5]/) }
    its('stdout') { should_not match(/:7\.0\.0\.6[0-2]/) }
  end

  describe command('/usr/bin/lslpp -Lqc Java71_64.jre') do
    its('stdout') { should_not match(/:7\.1\.0\.[0-3]/) }
    its('stdout') { should_not match(/:7\.1\.0\.4[0-2]/) }
  end

  describe command('/usr/bin/lslpp -Lqc Java71_64.sdk') do
    its('stdout') { should_not match(/:7\.1\.0\.[0-3]/) }
    its('stdout') { should_not match(/:7\.1\.0\.4[0-2]/) }
  end

  describe command('/usr/bin/lslpp -Lqc Java71.jre') do
    its('stdout') { should_not match(/:7\.1\.0\.[0-3]/) }
    its('stdout') { should_not match(/:7\.1\.0\.4[0-2]/) }
  end

  describe command('/usr/bin/lslpp -Lqc Java71.sdk') do
    its('stdout') { should_not match(/:7\.1\.0\.[0-3]/) }
    its('stdout') { should_not match(/:7\.1\.0\.4[0-2]/) }
  end

  describe command('/usr/bin/lslpp -Lqc Java8_64.jre') do
    its('stdout') { should_not match(/:8\.0\.0\.[0-4]/) }
    its('stdout') { should_not match(/:8\.0\.0\.5[01]/) }
    its('stdout') { should_not match(/:8\.0\.0\.520:/) }
  end

  describe command('/usr/bin/lslpp -Lqc Java8_64.sdk') do
    its('stdout') { should_not match(/:8\.0\.0\.[0-4]/) }
    its('stdout') { should_not match(/:8\.0\.0\.5[01]/) }
    its('stdout') { should_not match(/:8\.0\.0\.520:/) }
  end

  describe command('/usr/bin/lslpp -Lqc Java8.jre') do
    its('stdout') { should_not match(/:8\.0\.0\.[0-4]/) }
    its('stdout') { should_not match(/:8\.0\.0\.5[01]/) }
    its('stdout') { should_not match(/:8\.0\.0\.520:/) }
  end

  describe command('/usr/bin/lslpp -Lqc Java8.sdk') do
    its('stdout') { should_not match(/:8\.0\.0\.[0-4]/) }
    its('stdout') { should_not match(/:8\.0\.0\.5[01]/) }
    its('stdout') { should_not match(/:8\.0\.0\.520:/) }
  end
end

