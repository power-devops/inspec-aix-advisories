# encoding: utf-8
# copyright: 2017, The Authors

title 'openssh_advisory12'

control 'CVE-2018-15473' do
  impact 0.53
  title 'CVE-2018-15473'
  desc 'OpenSSH could allow a remote attacker to obtain sensitive 
        information, caused by different responses to valid and invalid 
        authentication attempts. By sending a specially crafted request, an 
        attacker could exploit this vulnerability to enumerate valid usernames.
  '

  tag 'openssh'
  tag 'aix', 'aix53', 'aix61', 'aix71', 'aix72'
  tag 'vios', 'vios2', 'vios3'
  tag :score, '5.3'
  ref 'http://aix.software.ibm.com/aix/efixes/security/openssh_advisory12.asc'

  only_if do
    os.aix?
  end

  describe command('/usr/bin/lslpp -Lqc openssh.base.client') do
    its('stdout') { should_not match(/:4\.[0-9]\./) }
    its('stdout') { should_not match(/:5\.[0-9]\./) }
    its('stdout') { should_not match(/:6\.[0-9]\./) }
    its('stdout') { should_not match(/:7\.[0-4]\./) }
    its('stdout') { should_not match(/:7\.5\.[0-9]\./) }
    its('stdout') { should_not match(/:7\.5\.[1-9][0-9]\./) }
    its('stdout') { should_not match(/:7\.5\.10[01]\./) }
    its('stdout') { should_not match(/:7\.5\.102\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.5\.102\.[1-9][0-9]:/) }
    its('stdout') { should_not match(/:7\.5\.102\.[1-9][0-9][0-9]:/) }
    its('stdout') { should_not match(/:7\.5\.102\.1[0-4][0-9][0-9]:/) }
  end

  describe command('/usr/bin/lslpp -Lqc openssh.base.server') do
    its('stdout') { should_not match(/:4\.[0-9]\./) }
    its('stdout') { should_not match(/:5\.[0-9]\./) }
    its('stdout') { should_not match(/:6\.[0-9]\./) }
    its('stdout') { should_not match(/:7\.[0-4]\./) }
    its('stdout') { should_not match(/:7\.5\.[0-9]\./) }
    its('stdout') { should_not match(/:7\.5\.[1-9][0-9]\./) }
    its('stdout') { should_not match(/:7\.5\.10[01]\./) }
    its('stdout') { should_not match(/:7\.5\.102\.[0-9]:/) }
    its('stdout') { should_not match(/:7\.5\.102\.[1-9][0-9]:/) }
    its('stdout') { should_not match(/:7\.5\.102\.[1-9][0-9][0-9]:/) }
    its('stdout') { should_not match(/:7\.5\.102\.1[0-4][0-9][0-9]:/) }
  end

  if command('/usr/bin/lslpp -Lqc openssh.base.client').stdout.match(/:7\.5\.102\.1500:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/15473_fix/) }
    end
  end

  if command('/usr/bin/lslpp -Lqc openssh.base.server').stdout.match(/:7\.5\.102\.1500:/)
    describe command('/usr/sbin/emgr -l') do
      its('stdout') { should match(/15473_fix/) }
    end
  end
end
